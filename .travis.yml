---
dist: xenial
language: python
python: 3.7
# pre-commit hooks can use Docker, so we should go ahead and enable it
services: docker
env:
  global:
    - AWS_ACCESS_KEY=
    - AWS_SECRET_KEY=
    - BUILD_REGION="us-east-2"
    - DEPLOY_REGIONS="us-east-1,us-west-1,us-west-2"
    # - IMAGE_VERSION=
    - PACKER_VERSION="1.4.1"


# Cache pip packages and pre-commit plugins to speed up builds
cache:
  pip: true
  directories:
    - $HOME/.cache/pre-commit

before_install:
  # install packer.io
  - curl -o /tmp/packer.zip -L
      "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip"
  - unzip -o -d /usr/local/bin /tmp/packer.zip
  # install ansible
  - sudo apt-get update
  - sudo apt-get install -y software-properties-common
  - sudo apt-add-repository --yes --update ppa:ansible/ansible
  - sudo apt-get install -y ansible

install:
  - pip install --upgrade -r requirements-test.txt
  # install roles
  - ansible-galaxy install --force --role-file src/requirements.yml
  - IMAGE_VERSION=$(./bump_version.sh show)

script:
  - pre-commit run --all-files
