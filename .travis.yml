---
dist: xenial
language: python
python: 3.7
# pre-commit hooks can use Docker, so we should go ahead and enable it
services: docker
env:
  global:
    - AWS_DEFAULT_REGION="us-east-1"
    # AWS_ACCESS_KEY
    - secure: >-
        ZW7Dv9HG4uliuGAK5SkmNR99L8X5+qqkV3oOevWj2an5Man0EFPeWtQdndyiO42/SR0
        i4fbJU/QkDNE1INbsFD+r33i1wXb+cxmKMG9OUKy0+n5aERr1F4V91/Rq5WMgQziNXa
        AqoB1dWQCHq7YKIB3cH03nsGRx9xXVOaXc6ePAdCi8vvwlWe9ao6WUPFU6i9K9SJ15A
        Y8YePxL8x/fQ0JRNijSF3her7dLupWAW0icKBbl7h9mCfmB8nL/R5OsqqZOKR3J5sq9
        /qSvq0aOxVqANOePtrSJaSR4mLFYTmnFRkUd0RTmGB05zHXIcSVItv5NTP5DAvcMlKf
        nymhyjUPYHLhASxXgtwKWzy2coYm89Gh+A7NWXkkoK+WnI+HyBBSD3MvVPSxgZNgbsY
        nAEuBzF2U42bet++ZoTAd8SietiZY3G+QE7TI2UYnVZ5VHZB4B1NRiBzOQGBP0HeQ3u
        eN/4P76RX+HxQV6QIobscAJQVmscgeB4/ATOAARr3kkmwHEysvymNBM8JdFGSqnedsM
        kUucwsaRhS/0Ga2gWo0HVBV9/dZeZeIVW2Of/rRMNoYlaugX7KRLWRF3570OY9LPW2b
        OwjpUSzQQUI72FDi6nUwBTEvyCjDjut3wx/jlHtTDsYmpCvpbuLn/cjdEzI+EElJf2q
        JN6PsZnbb7b0=
    # AWS_SECRET_KEY
    - secure: >-
        d8celY9gGUEbiMP3f5J62niiBb1t3+hbCiUjihxAeXgQFpk5LY3UOzzYAqaGX9kYf+z
        IRf9O8pGUQAAWObTgvHTfj4ws1kp599nreKLtR2g52Cs0CB+JnYgfQV/KOqemlwT8Ut
        Lg4VDxEXXZTM9ja38HZDbHJDT0VY+D+xEgEmzPCbwoGEhAlu7CZhdpN8JHqQ154yJdS
        BWwupTfN1HBumsEsupHqNcxtb51RnRAG9/tKY4tZRoGqKD3JwIbDi88vmdNxL+BKzfr
        QgTXK9WzNT1SQCHnZViSyEnaZx0WpIjzIpFqbfDC4YiU3y6f1SnFT0mc7f91EuvdtCK
        QuH82uEEyyNzZBtnx9apgnpRYAjV0WacEDwI/qS+SaFBWgi/Oawd8isC2/++U5lqTAA
        +mYaJ3izNK5gmwY9FKQxLhVh6hZkMizbP8KAdccXbuRFywWfoVAo3MHcrHdNbX8BS0i
        cJlyFWOUdokrujZlNHcfNa/lqD0vrNEKGoUCy+b8YCjfm2lHcOBZ9Y2yDZoP3WcsxHB
        n9vKUTuIlaZhvV35P35pCIaDoXdt5mLjRb7ZCxtvH8jn2qFMf3uemZtRsOvhiI6rPNx
        3luI/CBTCXMiSafSqWZ/j/yJu8ILnMtR2m44naa9JaK8XR7eqODYfQSf3FbigqhABiZ
        vR04NgmKFbvrc=
    - BUILD_REGION="us-east-2"
    - DEPLOY_REGIONS="us-east-1,us-west-1,us-west-2"
    # - IMAGE_VERSION=
    - PACKER_VERSION="1.4.1"


# Cache pip packages and pre-commit plugins to speed up builds
cache:
  pip: true
  directories:
    - $HOME/.cache/pre-commit

before_install:
  # install packer.io
  - curl --output /tmp/packer.zip --location
      "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip"
  - sudo unzip -o -d /usr/local/bin /tmp/packer.zip

install:
  - pip install --upgrade --requirement requirements-test.txt
  - export IMAGE_VERSION=$(./bump_version.sh show)
  - eval $(./update_env.py)
  # install roles
  - ansible-galaxy install --force --role-file src/requirements.yml

script:
  - pre-commit run --all-files
  - packer validate src/packer.json
  - pytest

deploy:
  # create a production image
  - provider: script
    script: packer build --timestamp-ui src/packer.json
    on:
      tags: true
  # # create a testing image
  # - provider: script
  #   script: export IMAGE_VERSION=${IMAGE_VERSION}-pre &&
  #     packer build src/packer.json
  #   on:
  #     tags: false
