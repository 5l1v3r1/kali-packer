---
dist: xenial
language: python
python: 3.7
# pre-commit hooks can use Docker, so we should go ahead and enable it
services: docker
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "XWF9knzxYLl6i55v9MNEGDfBVaDl8UMrterOZiO9+waPeRumQR8HwBY\
    wDkMqykJ5LxAujBW9DZPUEH2zYmVI6omNZK0rH1TTcHfdt65pp54u7mffmEDyk84fY\
    A0Z+B1G7qB+y+G+1NOZfSR8397HuiNq40bD3X+Et40FZ1hndpEXZeRE1wZRVZYTve4\
    NrfLcH4nWmOrVOuLwCEYj00MWk4EFD79gg3k7wfL9ogMtXsc19Tsrw+rn8hrIB9xv8\
    hKKDaXP2VXESB0nWXAXAeoODq3AzTKzXhH/5f9sq3vgq2pCYWMd9mdYU1soOCfobp8\
    cWJXGjxnBcFrPo1BFJ9Fh6fn/4PmK27YVcbWOL5eAI3e7ZvS7lCOWfRn7xnlBNTDTP\
    li7g0JVZGMDadzw1MSrhKak6vESIBk1Zk4tUlb+LlnzWep6OYCvqtcUi42l0yPSVqf\
    0Ap/nhOTw8oodI8zxVDTjZKX6hz/7wPW1ywayFUfS4zSUEGEBN6uZc36VDSVwUXZB+\
    2WHfNynF+d7NefRhp8YQTC7LVSBH3aMBT1RBLcMHDDekySOLTuphdXtNSoZ11gx3fC\
    WCdsqyALIWH1lHSQ5J+9hRJ1A+I9vcQ+PodQSbW0H6z9NP2jt6TeoSTBLNsswfh1yV\
    m0WFwHbIQUfF9VGQlVZ8tuEuBfKDTIg6oc="
    - AWS_DEFAULT_REGION="us-east-2"
    # AWS_SECRET_ACCESS_KEY
    - secure: "tQ7E56iSfDgfMv8Mo+EmKiiFhoV4QU9Q8NbumbYYkHiFK8ttOkjlekr\
    uaTsFaytQKBigmloBpc3vRcPN1jDa8BD5WuNzXhproqJtW6fiM+KrWC/HQuiqiWOEj\
    qmSNwAx/BTyDWHNYBNDdoAXGww2hgJwbHctib3JMUsCsoWC0Eqka50Fni2Fq79W/PD\
    /5yDw3VD78HMMEK3Rv/PpDPK4bTjg0gtKLm/H7q4D2kpsuu07VyXdkIab5fAH3lQo2\
    LCmOGFwWPVPqq4Jd/kQyxl/aSUItXBgTa9F69gN9xxXdqWiv45oSK445Zt29NqPSo/\
    Ug92zrpw3S/HvudbrlAlSn6zs8mo8expo8mMQUBQH8Q0VaI07S1pKBJMS4P0o2cpb1\
    gqnloqt2/Tle9HMEalSgc8Nu5w7clzNu//s7tCA/xUJnu2ot3QnLiFGYIc6dRpX6CF\
    DGWhmKoYPZiOjTAVWWml6WCyHJrGVYkUZg+K5tGSyplhwdsBvnV4MUfkuz07ZjxTrj\
    quWcuOLrGJiQMFmIYwtA8Re9EtZ8oNuVDp6GZ0W6KZgAQH0y3NiPkecKuUXiSyCx2h\
    PCWjlUoknHPM472EW7UlQ/K9LYL6FwD2aUKDVLg217pqga8Vz+IqndcjHOcT1w89BE\
    yQvlx/VkAB8o0U0z6QJald92LdgKhOST1U="
    - CURL_CACHE_DIR="$HOME/.cache/curl"
    # GITHUB_ACCESS_TOKEN
    - secure: "CMVLqC2AYZ78mEn8w1GWv3p7Ci5lProngCei/Fzin0KCYrsV+DEBQCm\
    6nKvv/wmEKIy79BpdF2GNwz23uiJXE8VF9A3WBM82coF5KfCO1CporqsQ25cLYSwCF\
    j8AxsT4n5JXHtXVsuNk0QETspZcDBjfOtdIS0p/YYArkpBS69NFJg4d7STcCPnIgRX\
    /06ksN9WRbliiiQ70gdkZpZE5ceqMH3mRiUFFKU9aTF2DnDDaYLVXbHqjtYL621HYa\
    /XywUQ6YZwFEbz8n4XwGqARILJOfz0FPJcKCOAnAnbGwY3ejef15lEMDZQuPzb7kPy\
    hhykpbNKY028781GyQxJrPMYx1AYOlAeP/vkFUGQvMXbOuEF6WLLv3CHsx1MX30EW3\
    bZL5FBgxwvg5v/PgFQNdh8Ma+e02D2p+AHWUCf3VhwHqdKovk3ebDRlF2geJYl8KP7\
    HiqSnKlITsvRxh+tZdvBR7rNv6+PjsjfR00hMI4KY45Z6eoLXcXz9icwT76Q1+Adnz\
    eMACE+Yb3HLdg4mfo6Ni3Fkdz+8ODw750crSsR1/TAGeFL8F+qp+1eqScMbz+vxoyv\
    yKDN3LCV3Sj6nmiE4d3UmjP/YKkQxD9cqCzBFMuUtJKgNajpbuy0WKdtkConb2wxSa\
    3bX4KmUdPpv1mLNg5ugcp+8PWT1/Bb0U2A="
    - PACKER_BUILD_REGION="us-east-2"
    - PACKER_DEPLOY_REGION_KMS_MAP="us-east-1:alias/cool/ebs,
                                    us-east-2:alias/cool/ebs,
                                    us-west-1:alias/cool/ebs,
                                    us-west-2:alias/cool/ebs"
    - PACKER_VERSION="1.4.3"
    - PACKER_ZIP="packer_${PACKER_VERSION}_linux_amd64.zip"
    - TERRAFORM_VERSION="0.12.7"
    - TERRAFORM_ZIP="terraform_${TERRAFORM_VERSION}_linux_amd64.zip"


# Cache pip packages, pre-commit plugins, and some curl downloads to
# speed up builds
cache:
  pip: true
  directories:
    - $HOME/.cache/pre-commit
    - $CURL_CACHE_DIR

before_install:
  # Make a cache directory for curl downloads
  - mkdir -p $CURL_CACHE_DIR
  # Install terraform
  - curl --output "${CURL_CACHE_DIR}/${TERRAFORM_ZIP}"
      --time-cond "${CURL_CACHE_DIR}/${TERRAFORM_ZIP}" --location
      "https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/${TERRAFORM_ZIP}"
  - sudo unzip -d /opt/terraform "${CURL_CACHE_DIR}/${TERRAFORM_ZIP}"
  - sudo ln -s /opt/terraform/terraform /usr/bin/terraform
  # Install packer
  - curl --output "${CURL_CACHE_DIR}/${PACKER_ZIP}"
      --time-cond "${CURL_CACHE_DIR}/${PACKER_ZIP}" --location
      "https://releases.hashicorp.com/packer/${PACKER_VERSION}/${PACKER_ZIP}"
  - sudo unzip -o -d /usr/local/bin "${CURL_CACHE_DIR}/${PACKER_ZIP}"

install:
  - pip install --upgrade --requirement requirements-test.txt
  - export PACKER_IMAGE_VERSION=$(./bump_version.sh show)
  # Install roles
  - ansible-galaxy install --force --role-file src/requirements.yml

script:
  - pre-commit run --all-files
  - ./patch_packer_config.py query-github src/packer.json
  - packer validate src/packer.json
  - pytest

before_deploy:
  - pip install travis-wait-improved

deploy:
  # create an image when tagged
  - provider: script
    # preserve patch to packer configuration by skipping cleanup
    skip_cleanup: true
    script: travis-wait-improved --timeout=30m packer build --timestamp-ui
      src/packer.json
    on:
      tags: true
